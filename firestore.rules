
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to make rules more readable
    function isSignedIn() {
      return request.auth != null;
    }

    // Checks if the requesting user is a member of a specific personal chat
    function isPersonalChatMember(roomId) {
      return isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/personalChats/$(roomId)).data.members;
    }

    // USER PROFILES
    // - Anyone can check for username/email existence (list).
    // - Any signed-in user can view a profile (get).
    // - Users can only create, update, or delete their own profile.
    match /users/{userId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update, delete: if isSignedIn() && request.auth.uid == userId;
    }
    
    match /users/{userId}/personalChats/{otherUserId} {
        allow read, update, create, delete: if isSignedIn() && request.auth.uid == userId;
    }

    // PUBLIC CHAT ROOMS (e.g., /chats/california)
    match /chats/{stateId} {
      allow read, create, update: if isSignedIn();

      // MESSAGES IN PUBLIC CHATS
      match /messages/{messageId} {
        allow read, create: if isSignedIn();
        allow update, delete: if isSignedIn() && request.resource.data.user.id == request.auth.uid;
      }
    }

    // PERSONAL CHAT ROOMS (e.g., /personalChats/uid1_uid2)
    match /personalChats/{roomId} {
        allow read, create, update: if isPersonalChatMember(roomId);

        // MESSAGES IN PERSONAL CHATS
        match /messages/{messageId} {
            allow read, create: if isPersonalChatMember(roomId);
            allow update, delete: if isPersonalChatMember(roomId) && request.resource.data.user.id == request.auth.uid;
        }
    }
    
    // REQUIREMENTS
    match /requirements/{reqId} {
        allow read, create: if isSignedIn();
        // Allow update/delete only by the author or an admin
        allow update, delete: if isSignedIn() && (request.resource.data.user.id == request.auth.uid || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true);
    }
    
    // OFFERS
    match /offers/{offerId} {
        allow read: if isSignedIn();
        // Allow write operations only for admins
        allow write: if isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
  }
}
