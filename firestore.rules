
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Users Collection
    // - A user can read/write to their own profile.
    // - Any authenticated user can query the users collection (e.g., for checking if a username is taken).
    match /users/{uid} {
      allow read, write: if request.auth.uid == uid;
      allow list: if request.auth.uid != null;
    }
    
    // Personal Chats Collection (`/users/{uid}/personalChats/{otherUid}`)
    // A user can read/write their own list of personal chats.
    match /users/{uid}/personalChats/{chatId} {
        allow read, write: if request.auth.uid == uid;
    }

    // Chats Collection
    match /chats/{roomId} {
        
      // Public State Chats (e.g., /chats/california)
      // - Any authenticated user can read messages.
      // - Any authenticated user can create messages.
      // - Any authenticated user can update the timestamp (required for sending messages).
      function isPublicStateChat() {
        return !(roomId.contains("_"));
      }

      allow update: if isPublicStateChat() && request.auth.uid != null;
      
      match /messages/{messageId} {
          allow read, create: if isPublicStateChat() && request.auth.uid != null;
          allow update, delete: if isPublicStateChat() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
      }
      
      // Personal Chats (e.g., /chats/user1_user2)
      // - Only the two users in the chat can read/write messages or update the room.
      function isPersonalChat() {
        return roomId.contains("_") && request.auth.uid in roomId.split("_");
      }
      
      allow update: if isPersonalChat();

      match /messages/{messageId} {
        allow read, write: if isPersonalChat();
      }
    }
    
    // Requirements Collection
    // - Any authenticated user can read the requirements list.
    // - Only admins can write/delete requirements (they are created via server-side flows).
    match /requirements/{reqId} {
        allow read: if request.auth.uid != null;
        allow write, delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // Offers Collection
    // - Any authenticated user can read offers.
    // - Only admins can write/delete offers.
    match /offers/{offerId} {
        allow read: if request.auth.uid != null;
        allow write, delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // Flagged Content (for admin training)
    // - Only admins can read/write.
    match /flagged_content/{contentId} {
        allow read, write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
  }
}
